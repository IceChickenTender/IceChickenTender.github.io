name: Update RAG Vector Store

on:
  push:
    paths:
      # _posts 폴더 및 그 하위의 모든 폴더(**) 내의 .md 파일을 감시합니다.
      - '_posts/**/*.md' 
    branches:
      - main
      - feature/retriever_with_rag

jobs:
  update-vectors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install langchain langchain-openai langchain-community supabase python-frontmatter

      # [수정된 부분] files 패턴을 재귀적 패턴(**)으로 변경합니다.
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
             _posts/**/*.md

      - name: Run Update Script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # 인자로 전달되는 파일 경로들이 이제 'category/post.md' 형태로 전달됩니다.
          python scripts/sync_to_supabase.py \
            --added_modified "${{ steps.changed-files.outputs.all_changed_files }}" \
            --deleted "${{ steps.changed-files.outputs.deleted_files }}"